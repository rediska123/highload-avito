# AVITO

avito (avito.ru) — российский интернет-сервис для размещения объявлений о товарах, недвижимости, вакансиях и резюме на рынке труда, а также услугах, занимающий первое место в мире среди сайтов объявлений

Аудитория:
- MAU 72M [1]
- DAU 20.4M [2] [3]

Распределение пользователей по странам: [3]
| Страна  | Доля |
|---------|------|
| Россия | 96.33% |
| Украина | 0.57% |
|Нидерланды | 0.53% |
|Германия | 0.42% |
|США | 0.32% |

Ключевой функционал:
Создание объявлений и оформление заказов

Ключевое продуктовое решение:
Объявления создаются пользователями

Функционал MVP:
- Авторизация
- Поиск объявлений
- Просмотр объявлений
- Создание объявлений
- Оформление заказа

Анализ трафика:

- 237 млн. активных объявлений [4]
- 15 млн. объявлений в день [4]
- 10 сделок в секунду [4]
- несколько тысяч запросов в секунду на поиск [5]
- 32 млрд. картинок в хранилище [4]
- 80 млн. объявлений - автозагрузки [6]

## Расчет нагрузки

| Метрика | Значение |
| ------- | -------- |
| MAU [1] | 72 млн |
| DAU [2] [3] | 20.4 млн |
| Пользователи мобильных устройств | 78% |
| Отзывов в день | 130 тыс |
| Активных объявлений [4] | 237 млн |
| Объявлений в день [4] | 2 млн |
| Сделок в секунду [4] | 10 |
| Поисковых запросов в день [7] [8] | 21 млн |
| Картинок в хранилище [4] | 32 млрд |
| Среднее количество картинок в объявлении | 5 |
| Средний размер картинок в объявлении | 187,6Кб |
| Отношение картинок в отзывах к отзывам | 1:3 |
| Средний размер картинок в отзывах | 76Кб |
| Объявлений автозагрузок [6] | 80 млн |

Поисковых запросов в день в 2018: 10млн [7], МАУ в 2018: 34,1млн [8]  
MAU в 2025: 72млн =\> 10 \* 72/34.1 = 21млн. поисковых запросов в день

 Отзывы оставляют 15% пользователей. 10 Сделок совершается в секунду  
 86400 \* 0.15 \* 10 = 129 600 отзывов в день

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Количество на пользователя</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Авторизация</td>
<td>0,01</td>
<td><p>90% пользователей остаются авторизованными 30+ дней. Пусть 80% MAU - авторизованные пользователи</p>
<p>72 млн * 0,8 = 57,6 млн</p>
<p>10% авторизовываются заново в месяц. Это 5,76 млн пользователей</p>
<p>5,76 млн / 30 дней / 20,4 млн = 0,01</p></td>
</tr>
<tr>
<td>Поиск объявлений</td>
<td>1,03</td>
<td>21 млн / 20,4 млн = 1,03</td>
</tr>
<tr>
<td>Просмотр объявлений</td>
<td>4</td>
<td>В 2014 количество просмотров страниц сайта (объявлений) составило
18млн, ДАУ 4,5млн [9] =&gt; 4 просмотренных объявления на пользователя в
день</td>
</tr>
<tr>
<td>Создание объявлений</td>
<td>0,098</td>
<td>2 млн / 20,4 млн = 0,098</td>
</tr>
<tr>
<td>Оформление заказа</td>
<td>0,042</td>
<td>10 * 24 * 3600 / 20.4 млн = 864 тыс / 20,4 млн = 0,042</td>
</tr>
<tr>
<td>Написание отзыва</td>
<td>0,006</td>
<td><p>Примерно 15% оставляют отзывы</p>
<p>10 * 24 * 3600 * 0.15 / 20,4 млн = 129,6 тыс / 20,4 млн =</p></td>
</tr>
<tr>
<td>Добавление в избранное</td>
<td>0,4</td>
<td>В избранное добавляют каждое 10 просмотренное объявление. 4 * 0,1 = 0,4</td>
</tr>
</tbody>
</table>

RPS = Кол-во на пользователя \* DAU / 86400

| Действие               | RPS | Пиковый | Расчет                           |
|------------------------|-----|---------|----------------------------------|
| Авторизация            | 2,4 | 7,2     | 0,01 \* 20,4 млн / 86400 = 2,4   |
| Поиск объявлений       | 243 | 729     | 1,03 \* 20,4 млн / 86400 = 243,2 |
| Просмотр объявлений    | 944 | 2832    | 4 \* 20,4 млн / 86400 = 944,4    |
| Создание объявлений    | 23  | 69      | 0,098 \* 20,4 млн / 86400 = 23,1 |
| Оформление заказа      | 10  | 30      | 0,042 \* 20,4 млн / 86400 = 9,9  |
| Написание отзыва       | 1,4 | 4,2     | 0,006 \* 20,4 млн / 86400 = 1,4  |
| Добавление в избранное | 94,4| 283,2   | 0,4 \* 20,4 млн / 86400 = 94,44  |

Суточная активность
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Трафик</th>
<th>Пиковый трафик</th>
<th>Суточный трафик</th>
<th>Размер запроса</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Авторизация</td>
<td>0,000154</td>
<td>0,000461</td>
<td>1,6Гб</td>
<td>8Кб</td>
<td><p>В профиле аватар 2 видов:</p>
<p>Пользовательский (~10Кб)</p>
<p>По умолчанию (~3Кб)</p>
<p>(3кб + 10кб) / 2 = 6.5Кб на аватар + пользовательская информация
(Имя, Телефон, Пароль и тд) = 8Кб</p>
<p>8Кб * 2,4 = 19,2Кб</p></td>
</tr>
<tr>
<td>Поиск объявлений</td>
<td>0,005832</td>
<td>0,017120</td>
<td>60Гб</td>
<td>3Кб</td>
<td>3Кб * 243 = 729Кб</td>
</tr>
<tr>
<td>Просмотр объявлений</td>
<td>7,552</td>
<td>22,160</td>
<td>77,8Тб</td>
<td>1Мб</td>
<td><p>Средний размер картинки в объявлении 187,6Кб</p>
<p>В среднем в объявлении 5 картинок</p>
<p>187.6 * 5 = 938кб – картинки</p>
<p>В сумме с текстовой информацией округлим до 1Мб</p>
<p>1Мб * 944 = 944Мб</p></td>
</tr>
<tr>
<td>Создание объявлений</td>
<td>0,184</td>
<td>0,552</td>
<td>1,89Тб</td>
<td>1Мб</td>
<td><p>Аналогично просмотру 1Мб</p>
<p>1Мб * 23 = 23Мб</p></td>
</tr>
<tr>
<td>Оформление заказа</td>
<td>0,00024</td>
<td>0,00072</td>
<td>2,47Гб</td>
<td>3Кб</td>
<td>3Кб * 10 = 30Кб</td>
</tr>
<tr>
<td>Написание отзыва</td>
<td>0,000291</td>
<td>0,000874</td>
<td>3Гб</td>
<td>26Кб</td>
<td><p>76кб – средний размер картинки в отзыве</p>
<p>Соотношение картинок в отзывах к их количеству = 1:3</p>
<p>76Кб / 3 = 25,3Кб – картинка на каждый отзыв</p>
<p>Средний размер отзыва 256 символов, это 512 байт текста UTF-8</p>
<p>25,3Кб + 0,5Кб = 25,8Кб</p>
<p>Округлим до 26Кб</p>
<p>26Кб * 1,4 = 36,4Кб</p></td>
</tr>
<tr>
<td>Добавление в избранное</td>
<td>0,000755</td>
<td>0,002264</td>
<td>7,8Гб</td>
<td>1Кб</td>
<td>1Кб * 94,4 = 94,4Кб</td>
</tr>
</tbody>
</table>


Расчет хранилища

<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Трафик</th>
<th>Пиковый трафик</th>
<th>Объем</th>
<th>Размер запроса</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Объявления</td>
<td>729Кб</td>
<td>2,14Мб</td>
<td>5,5Пб</td>
<td>3Кб</td>
<td><p>Аппроксимировал MAU по годам. Использовал следующие значения</p>
<p>
2010 11 [10] <br>
2013 16,5 [10] <br>
2018 32 [2] <br>
2019 35 [2] <br>
2020 47 [2] <br>
2022 50 [2] <br>
2023 60 [2] <br>
2025 72 [2] <br>
</p>
<p>Из [2] известно, что на момент 2025 года в день создается 2млн объявлений</p>
<p>Будем считать что зависимость между количеством созданных объявлений и MAU линейная. Умножим поучившиеся значения на 365 чтобы узнать сколько было создано объявлений в год</p>
<p>
Год--МAU---В день--В год<br>
2025 72млн 2.00млн 730млн<br>
2024 65млн 1.81млн 659млн<br>
2023 58млн 1.61млн 588млн<br>
2022 52млн 1.44млн 527млн<br>
2021 47млн 1.31млн 477млн<br>
2020 42млн 1.17млн 426млн<br>
2019 37млн 1.03млн 375млн<br>
2018 33млн 0.92млн 335млн<br>
2017 29млн 0.81млн 294млн<br>
2016 25млн 0.69млн 253млн<br>
2015 22млн 0.61млн 223млн<br>
2014 19млн 0.53млн 193млн<br>
2013 17млн 0.47млн 172млн<br>
2012 14млн 0.39млн 142млн<br>
2011 12млн 0.33млн 122млн<br>
2010 11млн 0.31млн 112млн<br>
2009 10млн 0.28млн 101млн<br>
2008 9млн  0.25млн 91млн<br>
2007 8млн  0.22млн 81млн<br>
</p>
<p>В сумме 5,9млрд объявлений</p>
<p>Одно объявление весит 1Мб</p>
<p>5,9млрд * 1Мб = 5,5Пб</p></td>
</tr>
<tr>
<td>Отзывы</td>
<td>36,4Кб</td>
<td>109,2Кб</td>
<td>7,42Тб</td>
<td>26Кб</td>
<td><p>Отзывы добавили в 2018 году, а в 2019 добавили возможность
прикреплять изображение</p>
<p>Суточный трафик </p>
<p>1Кб * 1,4 * 86400 = 118Мб – суточный трафик</p>
<p>118Мб * 30 * 12 = 41,5Гб – хранилище отзывов до введения картинок</p>
<p>После введения суточный трафик 3Гб</p>
<p>3 * 30 * 12 * 7 = 7560Гб</p>
<p>7560Гб + 41,5Гб = 7,42Тб</p></td>
</tr>
<tr>
<td>Избранное</td>
<td>94,4Кб</td>
<td>283,2Кб</td>
<td>33,3Тб</td>
<td>1Кб</td>
<td><p>Возможность добавления в избранное добавили в 2013 году</p>
<p>Размер запроса 1Кб</p>
<p>Суточный трафик 7,8Гб</p>
<p>7,8Гб * 12 * 365 = 33,3Тб</p>
</tr>
</tbody>
</table>

## Глобальная балансировка нагрузки

Объявления по городам (центр города + 25км)
| Город | Кол-во объявлений (млн) | Доля от общего объёма (%) |
|-------|-------------------------|---------------------------|
| Москва | 44,1 | 40,4 |
| Санкт Петербург | 16,3 | 14,9 |
| Краснодар| 6,2 | 5,7 |
| Казань | 4,9 | 4,5 |
| Екатеринбург | 4,6 | 4,2 |
| Ростов на Дону | 4,5 | 4,1 |
| Нижний Новгород | 3,8 | 3,5 |
| Новосибирск | 3,8 | 3,5 |
| Челябинск | 3,5 | 3,2 |
| Уфа | 3 | 2,8 |
| Самара | 2,9 | 2,7 |
| Воронеж | 2,9 | 2,7 |
| Волгоград | 2,7 | 2,5 |
| Красноярск | 2,6 | 2,4 |
| Пермь | 2,3 | 2,1 |
| Омск | 2 | 1,8 |

Большая часть объявлений (40,4%) сосредоточена в Москве, а вместе с Санкт-Петербургом (14,9%) эти два города охватывают более половины всей нагрузки. Поэтому расположим все сервера в центральной России, тк здесь проживает основная часть пользователей авито

Время задержки от Москвы [11]
| Город | Задержка (мс) |
|-------|---------------|
| Москва | 7 |
| Санкт Петербург | 15 |
| Мурманск | 37 |
| Казань | 19 |
| Екатеринбург | 37 |
| Новосибирск | 53 |
| Владивосток | 118 |
| Омск | 46 |
| Краснодар | 27 |

Большинство крупных городов имеют задержку до Москвы менее 50мс. Поэтому все дата центры разместим в этом регионе. Для бесперебойной работы достаточно трёх дата центров: если один находится на обслуживании, а второй — под атакой или упал, то третий будет способен выдержать нагрузку

DNS-балансировки не будет из-за BGP anycast и нахождения всех выбранных датацентров в 1 городе
BGP anycast будем использовать для распределения трафика между 3 датацентрами в Москве для обеспечения надежности:
- на 3 датацентра выдается 1 ip
- при падаении одного из датацентра, трафик пойдет на 2 других датацентра

Датацентры будут выбраны так чтобы обеспечить равномерный трафик со всей цетральной России

Дополнительно на основе собранных логов будут выставлены коэффициенты на каждый сервер, чтобы провайдер понимал в какой датацентр идти (выбирается тот путь в BGP у которого наименьшее количество хопов)

Распределение rps по датацентрам
| Действие               | RPS  | Пиковый | ДЦ1  | ДЦ2  | ДЦ3  |
|------------------------|------|---------|------|------|------|
| Авторизация            | 2,4  | 7,2     | 2,4  | 2,4  | 2,4  |
| Поиск объявлений       | 243  | 729     | 243  | 243  | 243  |
| Просмотр объявлений    | 944  | 2832    | 944  | 944  | 944  |
| Создание объявлений    | 23   | 69      | 23   | 23   | 23   |
| Оформление заказа      | 10   | 30      | 10   | 10   | 10   |
| Написание отзыва       | 1,4  | 4,2     | 1,4  | 1,4  | 1,4  |
| Добавление в избранное | 94,4 | 283,2   | 94,4 | 94,4 | 94,4 |
| **Итого**              | **1318,2** | **3954,6** | **1318,2** | **1318,2** | **1318,2** |

Распределение трафика по датацентрам
| Действие | Трафик (Гбит) | Пиковый трафик (Гбит) | ДЦ1 (Гбит) | ДЦ2 (Гбит) | ДЦ3 (Гбит) |
|----------|----------------|------------------------|------------|------------|------------|
| Авторизация | 0.000154 | 0.000461 | 0.000154 | 0.000154 | 0.000154 |
| Поиск объявлений | 0.005832 | 0.017120 | 0.005680 | 0.005680 | 0.005680 |
| Просмотр объявлений | 7.552 | 22.64 | 7.552 | 7.552 | 7.552 |
| Создание объявлений | 0.184 | 0.552 | 0.184 | 0.184 | 0.184 |
| Оформление заказа | 0.000240 | 0.000720 | 0.000240 | 0.000240 | 0.000240 |
| Написание отзыва | 0.000291 | 0.000874 | 0.000291 | 0.000291 | 0.000291 |

## Локальная балансировка нагрузки

Суммарный RPS: 2,4 + 243 + 944 + 23 + 10 + 1,4 + 94,4 = 1318,2

Пиковый RPS: 3954,6

Пиковый трафик: 3Гб/c => 1Гб/c на датацентр

Для оркестрации контейнеров и управления жизненным циклом сервисов используем Kubernetes
- При запуске нового экземпляра сервиса Kubernetes создаёт контейнер и проверяет с помощью health check
- Если контейнер падает или перестаёт отвечать Kubernetes перезапускает его
- Auto Scaling: на основе метрик (CPU, памяти) Kubernetes динамически масштабирует количество подов

Будем использовать балансировку на уровне приложений (L7) через NGINX как основной механизм распределения внешнего HTTP/HTTPS-трафика к сервисам в Kubernetes-кластере (в класетере работает стандартный балансировщик L4)
- Позволяет делать SSL терминацию (через session tickets)
- Решает проблему медленного клиента
- API-gateway
- Балансировка нагрузки Round Robin
- Собираем логи и ставит timeout на 99,9% (чтобы не вис сервис)
- VRRP для резервирования (работает 1 сервер из 2)

По данным nginx [12] для запросов 100Кб на 2 xeon 2699v4 - 9,871RPS. Этого с запасом хватит чтобы сервер отдавал пиковый rps

На каждый датацентр 2 таких сервера: 1 - работает, 1 - в резерве. 
Всего 3 датацентра, а значит 6 серверов

## Логическая схема БД

<img width="700" height="450" alt="Untitled(6)" src="https://github.com/user-attachments/assets/94168c11-87cd-44d1-9f70-7854f71ca416" />

Таблица с описанием таблиц
| Название таблицы | Описание |
|------------------|----------|
| profiles | Хранит данные пользователей |
| items | Хранит объявления |
| categories | Хранит категории объявлений |
| favorites | Хранит информацию о том, какие объявления пользователи добавили в избранное |
| reviews | Хранит отзывы, оставленные покупателями о продавцах и, при наличии, ответ от продавца |
| images | Хранит метаданные изображений|
| item_images | Связывает изображения с объявлениями, позволяя каждому объявлению иметь несколько фотографий |
| review_images | Связывает изображения с отзывами, чтобы покупатель мог приложить фото товара к своему отзыву |
| view_metrics | Фиксирует события просмотра объявлений |
| search_metrics | Фиксирует поисковые запросы пользователей |
| sessions | Хранит активные сессии пользователей, используемые для аутентификации |

Распределение таблиц по действиям
| Действие               | RPS  | Пиковый | Какие таблицы используются |
|------------------------|------|---------|----------------------------|
| Авторизация            | 2,4  | 7,2     | профиль |
| Поиск объявлений       | 243  | 729     | объявление, категория, метрика просмотра, метрика поиска|
| Просмотр объявлений    | 944  | 2832    | объявление, категория, метрика просмотра, профиль, изображения в объявлениях|
| Создание объявлений    | 23   | 69      | объявление, профиль, категория, изображения в объявлениях|
| Оформление заказа      | 10   | 30      | объявление |
| Написание отзыва       | 1,4  | 4,2     | профиль, объявление, отзыв, изображения в отзывах|
| Добавление в избранное | 94,4 | 283,2   | профиль, объявление, метрика просмотра |

Нагрузки (QPS) на чтение/запись
| Таблица             | Чтение (QPS) | Запись (QPS) | Расчёт чтения | Расчёт записи |
|---------------------|--------------|--------------|---------------|---------------|
| profiles            | 3195,6       | 3,3          | 7,2 + 2832 + 69 + 4,2 + 283,2             | новые пользователи - 5% от MAU = 72 * 0,05 = 3,6млн в месяц. В день 120тыс. Возьмем пик 10%, тогда пиковый QPS = 120 000 * 0.1 / 3600  = 3,3 |
| items               | 3947,4       | 69           | 729 + 2832 + 69 + 30 + 4,2 + 283,2        | 69                                 |
| categories          | 3630         | 69           | 729 + 2832 + 69                           | 69 (указывается при создании объявления)                                  |
| view_metrics        | 0            | 3844,2       | только собираем                           | 729 + 2832 + 283,2                |
| search_metrics      | 0            | 729          | только собираем                           | 729                                |
| favorites           | 37,5            | 283,2        | 72млн * 0,3 * 0,15 / 86400 = 37,5                                             | 283,2                              |
| reviews             | 474,36       | 4,2          | (2832 * 0,1 + 424,8) * 0,67 = 474,36          | 4,2                                |
| images              | 2832         | 73,2         | 2 832                                         | 69 + 4,2                           |
| sessions            | 175            | 7,2          | (72млн * 0,3 * 0,7) / 86400                      | 7,2                                |

| Название таблицы | Вес | Расчет |
|------------------|-----|--------|
| items_search | 2282 | 8 + 8 + 100 + 150 + 1000 + 8 + 8 + 1000 |
| search_metrics | 124 | 8 + 8 + 100 + 8 |
| items | 2714 | 8 + 8 + 150 + 8 + 1000 + 8 + 8 + 8 + 8 + 8 + 500 + 1000 |
| categories | 116 | 8 + 100 + 8 |
| category_attributes | 1116 | 8 + 8 + 100 + 1000 |
| reviews | 1098 | 8 + 8 + 8 + 8 + 500 + 8 + 500 + 8 + 50 |
| profiles | 454 | 8 + 20 + 60 + 50 + 50 + 150 + 100 + 8 + 8 |
| sessions | 24 | 8 + 8 + 8 |
| images | 124 | 8 + 100 + 8 + 8 |
| favorites | 274 | 8 + 8 + 8 + 150 + 100 |
| view_metrics | 33 | 8 + 8 + 8 + 8 + 1 |

## Физическая схема БД

<img width="700" height="450" alt="изображение" src="https://github.com/user-attachments/assets/ad528cbe-3676-43fe-a842-babde2df7d2f" />


В Manticore Search два типа данных: полнотекстовые поля и атрибуты [13] 

Полнотекстовые поля предназначены только для полнотекстового поиска, их значения не хранятся в явном виде и недоступны для фильтрации, сортировки или агрегации

Значение полей атрибутов хранятся в извлекаемом виде и используются для фильтрации, сортировки и группировки

search_text -  текстовое поле для полнотекстового поиска. В него объединяется весь нужный для поиска текст из объявления: заголовок (title), описание (description) и значения ключевых динамических атрибутов (например, для автомобилей это марка, модель, цвет и др, что может участвовать в поисковом запросе)

atributes - текстовое поле для фильтрации. После того как полнотекстовый поиск по search_text отобрал подходящие объявления, к ним применяются фильтры (например, для автомобилей это объем двигателя, тип кузова и др)

| Название таблицы          | Вес 1 строки (байт) | Количество строк (млн) | Общий вес (байт)         | Общий вес              |
|---------------------------|---------------------|------------------------|--------------------------|------------------------|
| items                     | 2714                | 59 000                 | 1.601e+14                | **145.61 ТБ**          |
| items_search              | 2282                | 237                    | 5,411e+11                | **503 ГБ**             |
| profiles                  | 454                 | 349                    | 1.584e+11                | **147.52 ГБ**          |
| reviews                   | 1098                | 341                    | 3.744e+11                | **348.69 ГБ**          |
| favorites                 | 274                 | 19 939                 | 5.463e+12                | **4.96 ТБ**            |
| images                    | 124                 | 32 000                 | 3.968e+12                | **3.61 ТБ**            |
| search_metrics            | 124                 | 61 959                 | 7.683e+12                | **7.00 ТБ**            |
| view_metrics              | 33                  | 240 754                | 7.945e+12                | **7.23 ТБ**            |
| sessions                  | 24                  | 55                     | 1.320e+9                 | **1.23 ГБ**            |
| categories                | 116                 | 0.012                  | 1.392e+6                 | **1.33 МБ**            |
| **ИТОГО**                 |                     |                        | **1.862e+14**            | **170 ТБ**             |

| Название таблицы | СУБД | Обоснование |
|------------------|------|-------------|
| items_search         | Manticore   | Таблица для поиска - требует сложных запросов, индексов, полнотекстового поиска |
| search_metrics       | ClickHouse  | Метрики поиска - мало чтения, много записи |
| items                | PostgreSQL  | Таблица товаров - много чтения, мало записи |
| images               | S3 (MinIO)  | Хранение ключей/метаданных изображений и самих изображений. Выдача URL-а |
| favorites            | PostgreSQL  | Отношения "пользователь - товар" требует ссылочной целостности |
| categories           | PostgreSQL  | Таблица категорий — иерархия, связи с другими таблицами |
| category_attributes  | PostgreSQL  | Атрибуты категорий — связь с категориями |
| reviews              | PostgreSQL  | Таблица отзывов - много чтения, мало записи |
| profiles             | PostgreSQL  | Профили пользователей — критична к безопасности и целостности |
| view_metrics         | ClickHouse  | Метрики просмотров - мало чтения, много записи |
| sessions             | Redis       | Сессии — можно потерять, нужно быстро обращаться |

Индексы:
- Таблица items
  - индекс для seller_profile_id
  - индекс для category_id
- Таблица favorites
  - индекс для profile_id и item_id
- Таблица reviews
  - индекс для seller_profile_id
  - индекс для buyer_profile_id
- Таблица categories
  - индекс для parent_id
- Таблица search_metrics
  - индекс для status

 Денормализация:
 - Таблица items
   - Количество просмотров
   - Количество лайков
   - Картинки товара
 - Таблица profiles
   - Картинка профиля
 - Таблица reviews
   - Картинки отзыва
 - Таблица favorites
   - Картинки объявления
   - Название объявления

Индексы:
| Таблица          | Кол-во строк    | Колонка              | Размер индекса | Размер (Гб) |
|------------------|-----------------|----------------------|-------------|-------------|
| items            | 59 000 000 000  | id                   | 8           | 472         |
| items            | 59 000 000 000  | category_id          | 8           | 472         |
| items            | 59 000 000 000  | seller_profile_id    | 8           | 472         |
| items_search     | 237 000 000     | id                   | 8           | 1,9         |
| items_search     | 237 000 000     | title                | 100         | 23,7        |
| items_search     | 237 000 000     | search_text          | 1000        | 237         |
| profiles         | 349 000 000     | id                   | 8           | 2,8         |
| reviews          | 341 000 000     | id                   | 8           | 2,8         |
| favorites        | 19 939 000 000  | id                   | 8           | 159,5       |
| favorites        | 19 939 000 000  | item_id              | 8           | 159,5       |
| favorites        | 19 939 000 000  | user_id              | 8           | 159,5       |
| categories       | 1 200           | id                   | 8           | 9,6e-06     |

Шардирование и резервирование:

- Сумма items - 1 416 гб разбиваем на 32 шардов ~= 44 гб индексы на каждом. Шардируем по seller_profile_id что бы могли быстро находить товары продавца
- Сумма favorites - 480 гб разбиваем на 8 шардов ~= 60 гб индексы на каждом. Шардируем по user_id что бы пользователь мог посмотреть свои избранные

по бенчмарку pgbench сервер на 9950x3d выдаёт [https://openbenchmarking.org/result/2510032-PTS-POSTGRES84](>2 000 000 tps)

| Название таблицы       | Шардирование                             | Резервирование          |
|------------------------|------------------------------------------|-------------------------|
| items_search           | -                                        | 1 реплика               |
| search_metrics         | -                                        | 1 реплика               |
| items                  | 32 шарда по item_id mod 32               | 1 реплика               |
| images                 | -                                        | 1 реплика               |
| favorites              | 8 шардов по profile_id mod 8             | 1 реплика               |
| categories             | -                                        | 1 реплика               |
| category_attributes    | -                                        | 1 реплика               |
| reviews                | -                                        | 1 реплика               |
| profiles               | -                                        | 1 реплика               |
| view_metrics           | -                                        | 1 реплика               |
| sessions               | -                                        | 1 реплика               |

Клиентские библиотеки / интеграции:
- https://github.com/redis/go-redis
- https://github.com/manticoresoftware/go-sdk
- https://github.com/jackc/pgx
- https://github.com/ClickHouse/clickhouse-go
- https://github.com/minio/minio

балансировка запросов:
- PostgreSQL — pgbouncer
- ClickHouse — встроенный
- Redis — встроенный
- Manticore — встроенный
- Minio — встроенный

бекапы: (с реплик)
- физические бекапы postgresql - раз в нделю
- бекап clickhouse - раз в неделю с помощью clickhouse-backup
- снапшоты redis - каждый день
- физический бекап manticore - раз в неделю



## Ссылки

1. https://career.avito.com/
2. https://mediascope.net/data/
3. https://hypestat.com/info/avito.ru
4. https://github.com/avito-tech/playbook
5. https://habr.com/en/companies/avito/articles/846832/
6. https://www.youtube.com/watch?v=CW5YybMziRM
7. https://habr.com/ru/companies/avito/articles/427743/
8. https://www.avito.ru/files/avito/reklama/media-ads/Avito_june_media_banners_2018.pdf
9. https://oborot.ru/news/avito-priotkryl-svoyu-statistiku-i71452.html
10. https://www.tadviser.ru/index.php/Компания:Avito.ru_(Авито,_КЕХ_еКоммерц)
11. https://ruvds.com/ru-rub#advantages
12. https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers
13. https://manual.manticoresearch.com/Creating_a_table/Data_types

[1]: https://career.avito.com/
[2]: https://mediascope.net/data/
[3]: https://hypestat.com/info/avito.ru
[4]: https://github.com/avito-tech/playbook
[5]: https://habr.com/en/companies/avito/articles/846832/
[6]: https://www.youtube.com/watch?v=CW5YybMziRM
[7]: https://habr.com/ru/companies/avito/articles/427743/
[8]: https://www.avito.ru/files/avito/reklama/media-ads/Avito_june_media_banners_2018.pdf
[9]: https://oborot.ru/news/avito-priotkryl-svoyu-statistiku-i71452.html
[10]: https://www.tadviser.ru/index.php/Компания:Avito.ru_(Авито,_КЕХ_еКоммерц)
[11]: https://ruvds.com/ru-rub#advantages
[12]: https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers
[13]: https://manual.manticoresearch.com/Creating_a_table/Data_types
