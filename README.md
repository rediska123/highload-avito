# AVITO

avito (avito.ru) — российский интернет-сервис для размещения объявлений о товарах, недвижимости, вакансиях и резюме на рынке труда, а также услугах, занимающий первое место в мире среди сайтов объявлений

Аудитория:
- MAU 72M [1]
- DAU 20.4M [2] [3]

Распределение пользователей по странам: [3]
| Страна  | Доля |
|---------|------|
| Россия | 96.33% |
| Украина | 0.57% |
|Нидерланды | 0.53% |
|Германия | 0.42% |
|США | 0.32% |

Ключевой функционал:
Создание объявлений и оформление заказов

Ключевое продуктовое решение:
Объявления создаются пользователями

Функционал MVP:
- Авторизация
- Поиск объявлений
- Просмотр объявлений
- Создание объявлений
- Оформление заказа

Анализ трафика:

- 237 млн. активных объявлений [4]
- 15 млн. объявлений в день [4]
- 10 сделок в секунду [4]
- несколько тысяч запросов в секунду на поиск [5]
- 32 млрд. картинок в хранилище [4]
- 80 млн. объявлений - автозагрузки [6]

## Расчет нагрузки

| Метрика | Значение |
| ------- | -------- |
| MAU [1] | 72 млн |
| DAU [2] [3] | 20.4 млн |
| Пользователи мобильных устройств | 78% |
| Отзывов в день | 130 тыс |
| Активных объявлений [4] | 237 млн |
| Объявлений в день [4] | 2 млн |
| Сделок в секунду [4] | 10 |
| Поисковых запросов в день [7] [8] | 21 млн |
| Картинок в хранилище [4] | 32 млрд |
| Среднее количество картинок в объявлении | 5 |
| Средний размер картинок в объявлении | 187,6Кб |
| Отношение картинок в отзывах к отзывам | 1:3 |
| Средний размер картинок в отзывах | 76Кб |
| Объявлений автозагрузок [6] | 80 млн |

Поисковых запросов в день в 2018: 10млн [7], МАУ в 2018: 34,1млн [8]  
MAU в 2025: 72млн =\> 10 \* 72/34.1 = 21млн. поисковых запросов в день

 Отзывы оставляют 15% пользователей. 10 Сделок совершается в секунду  
 86400 \* 0.15 \* 10 = 129 600 отзывов в день

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Количество на пользователя</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Авторизация</td>
<td>0,01</td>
<td><p>90% пользователей остаются авторизованными 30+ дней. Пусть 80% MAU - авторизованные пользователи</p>
<p>72 млн * 0,8 = 57,6 млн</p>
<p>10% авторизовываются заново в месяц. Это 5,76 млн пользователей</p>
<p>5,76 млн / 30 дней / 20,4 млн = 0,01</p></td>
</tr>
<tr>
<td>Поиск объявлений</td>
<td>1,03</td>
<td>21 млн / 20,4 млн = 1,03</td>
</tr>
<tr>
<td>Просмотр объявлений</td>
<td>4</td>
<td>В 2014 количество просмотров страниц сайта (объявлений) составило
18млн, ДАУ 4,5млн [9] =&gt; 4 просмотренных объявления на пользователя в
день</td>
</tr>
<tr>
<td>Создание объявлений</td>
<td>0,098</td>
<td>2 млн / 20,4 млн = 0,098</td>
</tr>
<tr>
<td>Оформление заказа</td>
<td>0,042</td>
<td>10 * 24 * 3600 / 20.4 млн = 864 тыс / 20,4 млн = 0,042</td>
</tr>
<tr>
<td>Написание отзыва</td>
<td>0,006</td>
<td><p>Примерно 15% оставляют отзывы</p>
<p>10 * 24 * 3600 * 0.15 / 20,4 млн = 129,6 тыс / 20,4 млн =</p></td>
</tr>
<tr>
<td>Добавление в избранное</td>
<td>0,4</td>
<td>В избранное добавляют каждое 10 просмотренное объявление. 4 * 0,1 = 0,4</td>
</tr>
</tbody>
</table>

RPS = Кол-во на пользователя \* DAU / 86400

| Действие               | RPS | Пиковый | Расчет                           |
|------------------------|-----|---------|----------------------------------|
| Авторизация            | 2,4 | 7,2     | 0,01 \* 20,4 млн / 86400 = 2,4   |
| Поиск объявлений       | 243 | 729     | 1,03 \* 20,4 млн / 86400 = 243,2 |
| Просмотр объявлений    | 944 | 2832    | 4 \* 20,4 млн / 86400 = 944,4    |
| Создание объявлений    | 23  | 69      | 0,098 \* 20,4 млн / 86400 = 23,1 |
| Оформление заказа      | 10  | 30      | 0,042 \* 20,4 млн / 86400 = 9,9  |
| Написание отзыва       | 1,4 | 4,2     | 0,006 \* 20,4 млн / 86400 = 1,4  |
| Добавление в избранное | 94,4| 283,2   | 0,4 \* 20,4 млн / 86400 = 94,44  |

Суточная активность

<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Трафик</th>
<th>Пиковый трафик</th>
<th>Суточный трафик</th>
<th>Размер запроса</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Авторизация</td>
<td>19,2Кб</td>
<td>57,6Кб</td>
<td>1,6Гб</td>
<td>8Кб</td>
<td><p>В профиле аватар 2 видов:</p>
<p>Пользовательский (~10Кб)</p>
<p>По умолчанию (~3Кб)</p>
<p>(3кб + 10кб) / 2 = 6.5Кб на аватар + пользовательская информация
(Имя, Телефон, Пароль и тд) = 8Кб</p>
<p>8Кб * 2,4 = 19,2Кб</p></td>
</tr>
<tr>
<td>Поиск объявлений</td>
<td>729Кб</td>
<td>2,14Мб</td>
<td>60Гб</td>
<td>3Кб</td>
<td>3Кб * 243 = 729Кб</td>
</tr>
<tr>
<td>Просмотр объявлений</td>
<td>944Мб</td>
<td>2,77Гб</td>
<td>77,8Тб</td>
<td>1Мб</td>
<td><p>Средний размер картинки в объявлении 187,6Кб</p>
<p>В среднем в объявлении 5 картинок</p>
<p>187.6 * 5 = 938кб – картинки</p>
<p>В сумме с текстовой информацией округлим до 1Мб</p>
<p>1Мб * 944 = 944Мб</p></td>
</tr>
<tr>
<td>Создание объявлений</td>
<td>23Мб</td>
<td>69Мб</td>
<td>1,89Тб</td>
<td>1Мб</td>
<td><p>Аналогично просмотру 1Мб</p>
<p>1Мб * 23 = 23Мб</p></td>
</tr>
<tr>
<td>Оформление заказа</td>
<td>30Кб</td>
<td>90Кб</td>
<td>2,47Гб</td>
<td>3Кб</td>
<td>3Кб * 10 = 30Кб</td>
</tr>
<tr>
<td>Написание отзыва</td>
<td>36,4Кб</td>
<td>109,2Кб</td>
<td>3Гб</td>
<td>26Кб</td>
<td><p>76кб – средний размер картинки в отзыве</p>
<p>Соотношение картинок в отзывах к их количеству = 1:3</p>
<p>76Кб / 3 = 25,3Кб – картинка на каждый отзыв</p>
<p>Средний размер отзыва 256 символов, это 512 байт текста UTF-8</p>
<p>25,3Кб + 0,5Кб = 25,8Кб</p>
<p>Округлим до 26Кб</p>
<p>26Кб * 1,4 = 36,4Кб</p></td>
</tr>
<tr>
<td>Добавление в избранное</td>
<td>94,4Кб</td>
<td>283Кб</td>
<td>7,8Гб</td>
<td>1Кб</td>
<td>1Кб * 94,4 = 94,4Кб</td>
</tr>
</tbody>
</table>

Расчет хранилища

<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 13%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Действие</th>
<th>Трафик</th>
<th>Пиковый трафик</th>
<th>Объем</th>
<th>Размер запроса</th>
<th>Расчет</th>
</tr>
</thead>
<tbody>
<tr>
<td>Объявления</td>
<td>729Кб</td>
<td>2,14Мб</td>
<td>5,5Пб</td>
<td>3Кб</td>
<td><p>Аппроксимировал MAU по годам. Использовал следующие значения</p>
<p>
2010 11 [10] <br>
2013 16,5 [10] <br>
2018 32 [2] <br>
2019 35 [2] <br>
2020 47 [2] <br>
2022 50 [2] <br>
2023 60 [2] <br>
2025 72 [2] <br>
</p>
<p>Из [2] известно, что на момент 2025 года в день создается 2млн объявлений</p>
<p>Будем считать что зависимость между количеством созданных объявлений и MAU линейная. Умножим поучившиеся значения на 365 чтобы узнать сколько было создано объявлений в год</p>
<p>
Год--МAU---В день--В год<br>
2025 72млн 2.00млн 730млн<br>
2024 65млн 1.81млн 659млн<br>
2023 58млн 1.61млн 588млн<br>
2022 52млн 1.44млн 527млн<br>
2021 47млн 1.31млн 477млн<br>
2020 42млн 1.17млн 426млн<br>
2019 37млн 1.03млн 375млн<br>
2018 33млн 0.92млн 335млн<br>
2017 29млн 0.81млн 294млн<br>
2016 25млн 0.69млн 253млн<br>
2015 22млн 0.61млн 223млн<br>
2014 19млн 0.53млн 193млн<br>
2013 17млн 0.47млн 172млн<br>
2012 14млн 0.39млн 142млн<br>
2011 12млн 0.33млн 122млн<br>
2010 11млн 0.31млн 112млн<br>
2009 10млн 0.28млн 101млн<br>
2008 9млн  0.25млн 91млн<br>
2007 8млн  0.22млн 81млн<br>
</p>
<p>В сумме 5,9млрд объявлений</p>
<p>Одно объявление весит 1Мб</p>
<p>5,9млрд * 1Мб = 5,5Пб</p></td>
</tr>
<tr>
<td>Отзывы</td>
<td>36,4Кб</td>
<td>109,2Кб</td>
<td>7,42Тб</td>
<td>26Кб</td>
<td><p>Отзывы добавили в 2018 году, а в 2019 добавили возможность
прикреплять изображение</p>
<p>Суточный трафик </p>
<p>1Кб * 1,4 * 86400 = 118Мб – суточный трафик</p>
<p>118Мб * 30 * 12 = 41,5Гб – хранилище отзывов до введения картинок</p>
<p>После введения суточный трафик 3Гб</p>
<p>3 * 30 * 12 * 7 = 7560Гб</p>
<p>7560Гб + 41,5Гб = 7,42Тб</p></td>
</tr>
<tr>
<td>Избранное</td>
<td>94,4Кб</td>
<td>283,2Кб</td>
<td>33,3Тб</td>
<td>1Кб</td>
<td><p>Возможность добавления в избранное добавили в 2013 году</p>
<p>Размер запроса 1Кб</p>
<p>Суточный трафик 7,8Гб</p>
<p>7,8Гб * 12 * 365 = 33,3Тб</p>
</tr>
</tbody>
</table>

## Глобальная балансировка нагрузки

Объявления по городам (центр города + 25км)
| Город | Кол-во объявлений (млн) | Доля от общего объёма (%) |
|-------|-------------------------|---------------------------|
| Москва | 44,1 | 40,4 |
| Санкт Петербург | 16,3 | 14,9 |
| Краснодар| 6,2 | 5,7 |
| Казань | 4,9 | 4,5 |
| Екатеринбург | 4,6 | 4,2 |
| Ростов на Дону | 4,5 | 4,1 |
| Нижний Новгород | 3,8 | 3,5 |
| Новосибирск | 3,8 | 3,5 |
| Челябинск | 3,5 | 3,2 |
| Уфа | 3 | 2,8 |
| Самара | 2,9 | 2,7 |
| Воронеж | 2,9 | 2,7 |
| Волгоград | 2,7 | 2,5 |
| Красноярск | 2,6 | 2,4 |
| Пермь | 2,3 | 2,1 |
| Омск | 2 | 1,8 |

Большая часть объявлений (40,4%) сосредоточена в Москве, а вместе с Санкт-Петербургом (14,9%) эти два города охватывают более половины всей нагрузки. Поэтому расположим все сервера в центральной России, тк здесь проживает основная часть пользователей авито

Время задержки от Москвы [11]
| Город | Задержка (мс) |
|-------|---------------|
| Москва | 7 |
| Санкт Петербург | 15 |
| Мурманск | 37 |
| Казань | 19 |
| Екатеринбург | 37 |
| Новосибирск | 53 |
| Владивосток | 118 |
| Омск | 46 |
| Краснодар | 27 |

Большинство крупных городов имеют задержку до Москвы менее 50мс. Поэтому все дата центры разместим в этом регионе. Для бесперебойной работы достаточно трёх дата центров: если один находится на обслуживании, а второй — под атакой или упал, то третий будет способен выдержать нагрузку

DNS-балансировки не будет из-за BGP anycast и нахождения всех выбранных датацентров в 1 городе
BGP anycast будем использовать для распределения трафика между 3 датацентрами в Москве для обеспечения надежности:
- на 3 датацентра выдается 1 ip
- при падаении одного из датацентра, трафик пойдет на 2 других датацентра

Датацентры будут выбраны так чтобы обеспечить равномерный трафик со всей цетральной России

Дополнительно на основе собранных логов будут выставлены коэффициенты на каждый сервер, чтобы провайдер понимал в какой датацентр идти (выбирается тот путь в BGP у которого наименьшее количество хопов)

Распределение rps по датацентрам
| Действие               | RPS  | Пиковый | ДЦ1  | ДЦ2  | ДЦ3  |
|------------------------|------|---------|------|------|------|
| Авторизация            | 2,4  | 7,2     | 2,4  | 2,4  | 2,4  |
| Поиск объявлений       | 243  | 729     | 243  | 243  | 243  |
| Просмотр объявлений    | 944  | 2832    | 944  | 944  | 944  |
| Создание объявлений    | 23   | 69      | 23   | 23   | 23   |
| Оформление заказа      | 10   | 30      | 10   | 10   | 10   |
| Написание отзыва       | 1,4  | 4,2     | 1,4  | 1,4  | 1,4  |
| Добавление в избранное | 94,4 | 283,2   | 94,4 | 94,4 | 94,4 |
| **Итого**              | **1318,2** | **3954,6** | **1318,2** | **1318,2** | **1318,2** |

Распределение трафика по датацентрам
| Действие | Трафик | Пиковый трафик | ДЦ1 | ДЦ2 | ДЦ3 |
|----------|--------|----------------|-----|-----|-----|
| Авторизация | 19,2Кб | 57,6Кб | 19,20Кб | 19,20Кб | 19,20Кб |
| Поиск объявлений | 729Кб | 2,14Мб | 0,71Мб | 0,71Мб | 0,71Мб |
| Просмотр объявлений | 944Мб | 2,77Гб | 0,92Гб | 0,92Гб | 0,92Гб |
| Создание объявлений | 23Мб | 69Мб | 23,00Мб | 23,00Мб | 23,00Мб |
| Оформление заказа | 30Кб | 90Кб | 30,00Кб | 30,00Кб | 30,00Кб |
| Написание отзыва | 36,4Кб | 109,2Кб | 36,40Кб | 36,40Кб | 36,40Кб |
| Добавление в избранное | 94,4Кб | 283Кб | 94,33Кб | 94,33Кб | 94,33Кб |

## Локальная балансировка нагрузки

Суммарный RPS: 2,4 + 243 + 944 + 23 + 10 + 1,4 + 94,4 = 1318,2

Пиковый RPS: 3954,6

Пиковый трафик: 3Гб/c => 1Гб/c на датацентр

Для оркестрации контейнеров и управления жизненным циклом сервисов используем Kubernetes
- При запуске нового экземпляра сервиса Kubernetes создаёт контейнер и проверяет с помощью health check
- Если контейнер падает или перестаёт отвечать Kubernetes перезапускает его
- Auto Scaling: на основе метрик (CPU, памяти) Kubernetes динамически масштабирует количество подов

Будем использовать балансировку на уровне приложений (L7) через NGINX как основной механизм распределения внешнего HTTP/HTTPS-трафика к сервисам в Kubernetes-кластере (в класетере работает стандартный балансировщик L4)
- Позволяет делать SSL терминацию (через session tickets)
- Решает проблему медленного клиента
- API-gateway
- Балансировка нагрузки Round Robin
- Собираем логи и ставит timeout на 99,9% (чтобы не вис сервис)
- VRRP для резервирования (работает 1 сервер из 2)

По данным nginx [12] для запросов 100Кб на 2 xeon 2699v4 - 9,871RPS. Этого с запасом хватит чтобы сервер отдавал пиковый rps

На каждый датацентр 2 таких сервера: 1 - работает, 1 - в резерве. 
Всего 3 датацентра, а значит 6 серверов

## Ссылки

1. https://career.avito.com/
2. https://mediascope.net/data/
3. https://hypestat.com/info/avito.ru
4. https://github.com/avito-tech/playbook
5. https://habr.com/en/companies/avito/articles/846832/
6. https://www.youtube.com/watch?v=CW5YybMziRM
7. https://habr.com/ru/companies/avito/articles/427743/
8. https://www.avito.ru/files/avito/reklama/media-ads/Avito_june_media_banners_2018.pdf
9. https://oborot.ru/news/avito-priotkryl-svoyu-statistiku-i71452.html
10. https://www.tadviser.ru/index.php/Компания:Avito.ru_(Авито,_КЕХ_еКоммерц)
11. https://ruvds.com/ru-rub#advantages
12. https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers

[1]: https://career.avito.com/
[2]: https://mediascope.net/data/
[3]: https://hypestat.com/info/avito.ru
[4]: https://github.com/avito-tech/playbook
[5]: https://habr.com/en/companies/avito/articles/846832/
[6]: https://www.youtube.com/watch?v=CW5YybMziRM
[7]: https://habr.com/ru/companies/avito/articles/427743/
[8]: https://www.avito.ru/files/avito/reklama/media-ads/Avito_june_media_banners_2018.pdf
[9]: https://oborot.ru/news/avito-priotkryl-svoyu-statistiku-i71452.html
[10]: https://www.tadviser.ru/index.php/Компания:Avito.ru_(Авито,_КЕХ_еКоммерц)
[11]: https://ruvds.com/ru-rub#advantages
[12]: https://blog.nginx.org/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers
